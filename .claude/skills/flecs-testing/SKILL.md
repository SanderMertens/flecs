---
name: flecs-testing
description: Build, test, and debug Flecs ECS library using bake build system. Use when working with Flecs tests, adding test cases, fixing bugs, or contributing to Flecs development. Handles test registration in project.json and running tests with proper library paths.
---

# Flecs ECS Testing and Development

Work with the Flecs Entity Component System library: build, test, debug, and contribute code.

## Prerequisites

- **bake** build system installed (check with `which bake`)
- Flecs source code repository
- macOS/Linux environment with dynamic library support

## Quick Start

### Build Flecs library

```bash
cd /path/to/flecs
bake rebuild
```

Library installs to `~/bake/arm64-Darwin/debug/lib/libflecs.dylib` (or platform-specific path).

### Run test suite

```bash
cd test/core
bake rebuild

# Set library path
export DYLD_LIBRARY_PATH=~/bake/lib:~/bake/arm64-Darwin/debug/lib:$DYLD_LIBRARY_PATH

# Run all tests in a suite
./bin/arm64-Darwin-debug/core TestSuiteName

# Run specific test
./bin/arm64-Darwin-debug/core TestSuite.test_name
```

## Adding New Tests

**CRITICAL: Do NOT edit `main.c` - it's auto-generated by bake from `project.json`**

### Step 1: Register test in project.json

Edit `test/core/project.json` and add test name to the appropriate testsuite:

```json
{
    "id": "OrderedChildren",
    "testcases": [
        "iter_no_children",
        "children_1_table",
        "your_new_test_name"
    ]
}
```

### Step 2: Implement test function

Create test in appropriate source file (e.g., `test/core/src/OrderedChildren.c`):

```c
void OrderedChildren_your_new_test_name(void) {
    ecs_world_t *world = ecs_mini();
    
    ECS_COMPONENT(world, Position);
    
    // Your test logic
    test_assert(condition);
    test_int(actual_value, expected_value);
    
    ecs_fini(world);
}
```

### Step 3: Rebuild and run

```bash
cd test/core
bake rebuild

export DYLD_LIBRARY_PATH=~/bake/lib:~/bake/arm64-Darwin/debug/lib:$DYLD_LIBRARY_PATH
./bin/arm64-Darwin-debug/core OrderedChildren.your_new_test_name
```

## Test Assertions

Common test macros:

```c
test_assert(condition)              // Assert boolean is true
test_int(actual, expected)          // Assert integers equal
test_uint(actual, expected)         // Assert unsigned integers equal  
test_bool(actual, expected)         // Assert booleans equal
test_str(actual, expected)          // Assert strings equal
test_expect_abort()                 // Expect test to abort (for error tests)
```

## Test Organization

Tests are organized by feature:

- `test/core/src/` - Core ECS functionality
- `test/query/src/` - Query system tests
- `test/addons/src/` - Addon features

Each test file corresponds to a testsuite in `project.json`.

## Example: Testing a Bug Fix

```c
void World_delete_empty_tables_while_readonly(void) {
    /* Test that ecs_delete_empty_tables fails when called during readonly mode
     * This is a bug fix test - ensures the readonly check works */
    ecs_world_t *world = ecs_mini();
    
    ECS_TAG(world, Tag);
    
    // Create and delete entities to make empty tables
    for (int i = 0; i < 10; i++) {
        ecs_entity_t e = ecs_new_w_id(world, Tag);
        ecs_delete(world, e);
    }
    
    // Enter readonly mode (simulating system execution)
    ecs_readonly_begin(world, false);
    
    // This should fail with ECS_INVALID_OPERATION
    test_expect_abort();
    ecs_delete_empty_tables(world, &(ecs_delete_empty_tables_desc_t){
        .delete_generation = 1
    });
    
    // Should not reach here
    test_assert(false);
    
    ecs_readonly_end(world);
    ecs_fini(world);
}
```

Don't forget to add `"delete_empty_tables_while_readonly"` to the World testsuite in `project.json`.

## Example: Testing to Confirm a Bug

```c
void OrderedChildren_inherited_children_w_isa(void) {
    /* Issue #1862: Children with is_a not iterating in correct order
     * Expected: [0, 1, 2]
     * Actual: [0, 2, 1] - this test FAILS, confirming the bug exists
     */
    ecs_world_t *world = ecs_mini();
    ECS_COMPONENT(world, Position);
    
    // Create prefab hierarchy with is_a relationships
    ecs_entity_t parent_prefab = ecs_new_w_id(world, EcsPrefab);
    ecs_add_id(world, parent_prefab, EcsOrderedChildren);
    
    // Create children with different is_a types
    ecs_entity_t child1 = ecs_new_w_id(world, EcsPrefab);
    ecs_add_pair(world, child1, EcsChildOf, parent_prefab);
    ecs_set(world, child1, Position, {0, 0});
    
    ecs_entity_t child2 = ecs_new_w_id(world, EcsPrefab);
    ecs_add_pair(world, child2, EcsChildOf, parent_prefab);
    ecs_set(world, child2, Position, {1, 1});
    
    ecs_entity_t child3 = ecs_new_w_id(world, EcsPrefab);
    ecs_add_pair(world, child3, EcsChildOf, parent_prefab);
    ecs_set(world, child3, Position, {2, 2});
    
    // Create instance
    ecs_entity_t instance = ecs_new(world);
    ecs_add_pair(world, instance, EcsIsA, parent_prefab);
    ecs_add_id(world, instance, EcsOrderedChildren);
    
    // Iterate and verify order
    int count = 0;
    ecs_iter_t it = ecs_children(world, instance);
    while (ecs_children_next(&it)) {
        for (int i = 0; i < it.count; i++) {
            const Position *p = ecs_get(world, it.entities[i], Position);
            test_int(p->x, count);  // Will fail if order is wrong
            count++;
        }
    }
    
    ecs_fini(world);
}
```

## Debugging Tests

### View test output

```bash
# Run specific test
./bin/arm64-Darwin-debug/core TestSuite.test_name

# Run with verbose output  
./bin/arm64-Darwin-debug/core TestSuite -v

# Run all tests in suite
./bin/arm64-Darwin-debug/core TestSuite
```

### Common test results

- `PASS: X, FAIL: Y, EMPTY: Z` - Test summary
- Assertion failures show line numbers: `test.c:123: assert failed`
- Abort traces show stack for expected failures

### Library not found error

If you see `dyld: Library not loaded`, set the library path:

```bash
export DYLD_LIBRARY_PATH=~/bake/lib:~/bake/arm64-Darwin/debug/lib:$DYLD_LIBRARY_PATH
```

### Test not found

If test isn't found, ensure:
1. Test name is in `project.json`
2. You ran `bake rebuild` after editing `project.json`
3. Test function exists in source file

## Key Files

- `test/core/project.json` - Test definitions (edit this, not main.c)
- `test/core/src/*.c` - Test implementations
- `src/world.c` - Core world operations
- `src/storage/table.c` - Table storage
- `include/flecs.h` - Public API

## Common Commands

```bash
# Full rebuild of library and tests
cd /path/to/flecs && bake rebuild
cd test/core && bake rebuild

# Run specific test suite
cd test/core
export DYLD_LIBRARY_PATH=~/bake/lib:~/bake/arm64-Darwin/debug/lib
./bin/arm64-Darwin-debug/core World
./bin/arm64-Darwin-debug/core Reference  
./bin/arm64-Darwin-debug/core OrderedChildren

# Run single test
./bin/arm64-Darwin-debug/core World.delete_empty_tables_while_readonly

# Clean build
cd test/core && bake clean && bake
```

## Troubleshooting

### Sparse.c test_param error

Known issue: `test_param` undefined in Sparse.c. This doesn't affect other tests. Tests still build and run.

### Tests not updating after edit

Always run `bake rebuild` after:
- Editing `project.json`
- Modifying test source files
- Changing library code

### Wrong test count

If test count is wrong, ensure:
1. All test names in `project.json` are registered
2. No duplicate test names
3. `bake rebuild` was run to regenerate `main.c`

## Best Practices

### Document test purpose

Add comments explaining what bug or feature you're testing:

```c
void MyTest_descriptive_name(void) {
    /* Issue #1234: Brief description of what's being tested
     * Expected behavior: X
     * Actual behavior: Y (if confirming a bug)
     */
```

### Keep tests focused

One test should verify one specific behavior or bug fix.

### Use descriptive test names

Good: `delete_empty_tables_while_readonly`
Bad: `test1`

### Test both success and failure

- Test that valid operations work
- Test that invalid operations fail correctly (use `test_expect_abort()`)

## Contributing Tests

When contributing tests to Flecs:

1. Create minimal reproduction of the bug
2. Add test to appropriate suite in `project.json`
3. Implement test in matching source file
4. Verify test fails before fix (for bug fixes)
5. Verify test passes after fix
6. Document expected vs actual behavior

## Next Steps

For complete Flecs documentation, see:
- [Flecs Manual](https://github.com/SanderMertens/flecs/blob/master/docs/Manual.md)
- [Flecs Quickstart](https://github.com/SanderMertens/flecs/blob/master/docs/Quickstart.md)
- [Flecs FAQ](https://github.com/SanderMertens/flecs/blob/master/docs/FAQ.md)
